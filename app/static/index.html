<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QuickBite — Order</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.max-w-app { max-width: 900px; }</style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="min-h-screen flex items-center justify-center p-6">
    <div class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-app">
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold">QuickBite — Order</h1>
        <div class="text-sm text-gray-500">Daily menu</div>
      </header>

      <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Menu -->
        <section class="md:col-span-2">
          <h2 class="text-lg font-medium mb-3">Menu</h2>
          <div id="menu" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
        </section>

        <!-- Cart & Checkout -->
        <aside class="md:col-span-1 bg-gray-50 rounded-lg p-4">
          <h2 class="text-lg font-medium mb-3">Your Order</h2>
          <div id="cartList" class="space-y-2 text-sm text-gray-700 mb-3">No items added.</div>
          <div class="flex items-center justify-between font-semibold mb-3">
            <span>Total</span>
            <span id="total">₹0.00</span>
          </div>

          <h3 class="text-sm font-medium">Delivery details</h3>
          <form id="checkoutForm" class="space-y-3 mt-2">
            <div>
              <label class="text-xs">Phone</label>
              <input id="phone" type="tel" inputmode="tel" required placeholder="9876543210"
                     class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
            </div>
            <div>
              <label class="text-xs">Address</label>
              <textarea id="address" rows="2" required placeholder="House, Street, City"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm"></textarea>
            </div>

            <div>
              <label class="text-xs">Payment QR</label>
              <div class="mt-2 p-3 bg-white rounded-md border">
                <img id="paymentQr" alt="UPI QR" src="" />
                <p class="text-xs text-gray-500 mt-2">Scan this QR to pay via UPI (<code>mybites@oxaxis</code>).</p>
              </div>
            </div>

            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 rounded-md">
              Checkout & Show QR
            </button>
          </form>

          <div id="success" class="hidden mt-4 p-3 rounded-md bg-green-50 text-green-800 text-sm"></div>
        </aside>
      </main>

      <footer class="mt-6 text-xs text-gray-500">Built with FastAPI + JS + Tailwind.</footer>
    </div>
  </div>

<script>
let MENU = [];
const cart = {};
const menuEl = document.getElementById('menu');
const cartListEl = document.getElementById('cartList');
const totalEl = document.getElementById('total');
const checkoutForm = document.getElementById('checkoutForm');
const successEl = document.getElementById('success');
const phoneInput = document.getElementById('phone');
const addressInput = document.getElementById('address');
const paymentQr = document.getElementById('paymentQr');

function formatCurrency(n){ return '₹' + n.toFixed(2); }

// Load menu from backend
async function loadMenu() {
  const res = await fetch('/api/menu');
  MENU = await res.json();
  renderMenu();
}

// Render menu cards
function renderMenu(){
  menuEl.innerHTML = '';
  MENU.forEach(item=>{
    const card = document.createElement('div');
    card.className = 'p-3 rounded-lg border bg-white flex flex-col justify-between';
    card.innerHTML = `
      <div>
        <h3 class="font-medium">${item.name}</h3>
        <p class="text-sm text-gray-500">${formatCurrency(item.price)}</p>
      </div>
      <div class="mt-3 flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <button data-id="${item.id}" class="decr px-2 py-1 rounded bg-gray-100">-</button>
          <span id="qty-${item.id}">0</span>
          <button data-id="${item.id}" class="incr px-2 py-1 rounded bg-gray-100">+</button>
        </div>
        <button data-id="${item.id}" class="add bg-blue-600 text-white px-3 py-1 rounded">Add</button>
      </div>
    `;
    menuEl.appendChild(card);
  });

  document.querySelectorAll('.incr').forEach(b=>b.addEventListener('click',()=>changeQty(b.dataset.id,1)));
  document.querySelectorAll('.decr').forEach(b=>b.addEventListener('click',()=>changeQty(b.dataset.id,-1)));
  document.querySelectorAll('.add').forEach(b=>b.addEventListener('click',()=>addToCart(b.dataset.id)));
}

// Quantity control
function changeQty(id,delta){
  const el = document.getElementById('qty-'+id);
  const cur = parseInt(el.innerText) || 0;
  el.innerText = Math.max(0, cur+delta);
}

// Add to cart
function addToCart(id){
  const qty = parseInt(document.getElementById('qty-'+id).innerText)||0;
  if(qty<=0){ alert('Increase quantity first'); return; }
  cart[id] = (cart[id]||0)+qty;
  document.getElementById('qty-'+id).innerText=0;
  renderCart();
}

// Render cart
function renderCart(){
  cartListEl.innerHTML='';
  let total=0;
  const entries = Object.keys(cart).map(k=>{
    const item = MENU.find(i=>i.id==k);
    return { ...item, qty: cart[k] };
  });
  if(entries.length===0){
    cartListEl.innerHTML='No items added.';
    totalEl.innerText=formatCurrency(0);
    return;
  }
  entries.forEach(e=>{
    total+=e.price*e.qty;
    const row=document.createElement('div');
    row.className='flex items-center justify-between';
    row.innerHTML=`
      <div>
        <div class="font-medium">${e.name}</div>
        <div class="text-xs text-gray-500">${e.qty} × ${formatCurrency(e.price)}</div>
      </div>
      <div class="text-sm font-medium">${formatCurrency(e.price*e.qty)}</div>
    `;
    cartListEl.appendChild(row);
  });
  totalEl.innerText=formatCurrency(total);
}

// Auto-fill returning user
phoneInput.addEventListener('blur', async ()=>{
  const phone = phoneInput.value.trim();
  if(phone.length===10){
    const res = await fetch('/api/user/'+phone);
    const data = await res.json();
    if(data.last_address) addressInput.value = data.last_address;
  }
});

// Checkout
checkoutForm.addEventListener('submit', async e=>{
  e.preventDefault();
  if(Object.keys(cart).length===0){ alert('Cart is empty'); return; }
  const phone = phoneInput.value.trim();
  const address = addressInput.value.trim();
  if(phone.length!==10){ alert('Enter valid 10-digit phone'); return; }
  if(address.length<6){ alert('Enter full address'); return; }

  const items = Object.keys(cart).map(k=>{
    const item = MENU.find(i=>i.id==k);
    return { id:item.id, name:item.name, price:item.price, qty: cart[k] };
  });

  const formData = new FormData();
  formData.append('phone', phone);
  formData.append('address', address);
  formData.append('items', JSON.stringify(items));

  const res = await fetch('/api/order',{ method:'POST', body:formData });
  const data = await res.json();
  if(data.success){
    successEl.innerHTML=`<div class="font-semibold">Order placed! Total: ₹${data.total.toFixed(2)}</div>`;
    successEl.classList.remove('hidden');
    paymentQr.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=upi://pay?pa=mybites@oxaxis&pn=MyBites&am=${data.total.toFixed(2)}`;
  } else {
    alert('Order failed');
  }
});

loadMenu();
</script>

</body>
</html>
